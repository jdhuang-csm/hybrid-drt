import numpy as np

from hybdrt.models import DRT, DiscreteElementModel

def test_drt_fit_eis():
    freq = np.logspace(6, -1, 71)
    # Noisy simulated data from 3-HN model
    z_noisy = np.array([
        0.99889671+0.62833408j, 1.00364568+0.49781925j,
        1.00802691+0.38723232j, 1.00868921+0.29846879j,
        1.01193953+0.2428213j , 1.01167283+0.18923525j,
        1.01045899+0.14173219j, 1.01238999+0.10196859j,
        1.02235713+0.07665613j, 1.0179453 +0.05918841j,
        1.01815705+0.03406093j, 1.02482687+0.02169228j,
        1.02840612+0.00164515j, 1.03968502-0.01330543j,
        1.03310749-0.02751008j, 1.05056441-0.04152612j,
        1.05762158-0.04401618j, 1.06837122-0.0523578j ,
        1.07359505-0.05895716j, 1.09137543-0.06154152j,
        1.10002385-0.0577652j , 1.11654741-0.0612978j ,
        1.12038788-0.05449876j, 1.13607981-0.05682261j,
        1.1444828 -0.06512134j, 1.14813794-0.06226965j,
        1.1529311 -0.06317847j, 1.17390042-0.06342293j,
        1.17778932-0.0676267j , 1.19168201-0.07460637j,
        1.20029145-0.07316576j, 1.19913226-0.08130117j,
        1.21694161-0.09472669j, 1.22941691-0.09355075j,
        1.24410305-0.11112609j, 1.25726756-0.11285912j,
        1.26743061-0.10348278j, 1.28597281-0.12893697j,
        1.30467801-0.14401065j, 1.32656415-0.1521387j ,
        1.3521177 -0.15353221j, 1.38470823-0.1607032j ,
        1.40523225-0.18158171j, 1.4434634 -0.18865052j,
        1.47156977-0.18284169j, 1.49632288-0.18323229j,
        1.52847188-0.18958442j, 1.55965783-0.19855012j,
        1.58105599-0.20208253j, 1.62653981-0.1810663j ,
        1.64960656-0.18390339j, 1.68402514-0.16729184j,
        1.7129335 -0.16708122j, 1.73225266-0.14868366j,
        1.75441692-0.14412821j, 1.77836734-0.14484088j,
        1.79861273-0.14164223j, 1.81508215-0.12675187j,
        1.83830849-0.12669647j, 1.84387732-0.10207541j,
        1.85843918-0.09934482j, 1.88833325-0.10690078j,
        1.88512901-0.08903131j, 1.90256583-0.08346884j,
        1.9059794 -0.06585967j, 1.9272862 -0.06949637j,
        1.93782168-0.06116268j, 1.94043462-0.05517752j,
        1.94148382-0.04811498j, 1.94846802-0.0405763j ,
        1.97133255-0.02605813j
    ])
    
    expected_result = {
        'x': np.array([0.00019874, 0.00041775, 0.00069699, 0.00098508, 0.00127749,
        0.00155336, 0.00180174, 0.0020093 , 0.00216608, 0.00226478,
        0.00230431, 0.00229261, 0.00224983, 0.00220968, 0.00221841,
        0.00233105, 0.00260575, 0.00309815, 0.00385803, 0.0049305 ,
        0.00636303, 0.00821776, 0.01058845, 0.01361917, 0.01747668,
        0.02213164, 0.02700166, 0.03101173, 0.03321168, 0.03328916,
        0.03160234, 0.02888696, 0.02589884, 0.02317529, 0.02098151,
        0.01938761, 0.01837268, 0.01789392, 0.01791649, 0.01842183,
        0.01940827, 0.02088956, 0.02289336, 0.0254588 , 0.02863303,
        0.03246775, 0.03701578, 0.04231712, 0.04836101, 0.0550291 ,
        0.06205095, 0.06900713, 0.07540005, 0.08077218, 0.08480078,
        0.08729458, 0.08811254, 0.08712343, 0.08429337, 0.07983642,
        0.07426128, 0.06823928, 0.062385  , 0.05710335, 0.0525589 ,
        0.0487345 , 0.04551335, 0.04274385, 0.04027294, 0.03795622,
        0.03565898, 0.03326137, 0.03067286, 0.02785433, 0.02483919,
        0.0217362 , 0.01869895, 0.01586952, 0.01333301, 0.01111093,
        0.009184  , 0.00751758, 0.00607658, 0.00483089, 0.00375698,
        0.00283644, 0.00205698, 0.00140697, 0.00088439, 0.00047408,
        0.00019762]),
        'R_inf': np.float64(0.997377866144492),
        'inductance': np.float64(1.0101699023637295e-07),
        'C_inv': 0,
        'v_sigma_tot': None,
        'v_sigma_res': None,
        'z_sigma_tot': np.array([0.00352773+0.00393066j, 0.00355584+0.0039453j ,
                0.00358423+0.00396083j, 0.00361284+0.00397739j,
                0.00364164+0.00399509j, 0.00367057+0.00401407j,
                0.00369959+0.0040345j , 0.00372863+0.00405652j,
                0.00375765+0.00408032j, 0.00378659+0.00410607j,
                0.00381541+0.00413395j, 0.00384406+0.00416412j,
                0.0038725 +0.00419677j, 0.0039007 +0.00423202j,
                0.00392864+0.00427003j, 0.00395629+0.00431088j,
                0.00398365+0.00435465j, 0.00401072+0.00440137j,
                0.00403752+0.00445102j, 0.00406408+0.00450355j,
                0.00409042+0.00455885j, 0.00411659+0.00461677j,
                0.00414266+0.00467709j, 0.00416869+0.00473957j,
                0.00419474+0.00480392j, 0.00422089+0.00486982j,
                0.00424723+0.0049369j , 0.00427383+0.00500477j,
                0.00430076+0.00507305j, 0.00432811+0.00514131j,
                0.00435594+0.00520914j, 0.00438432+0.00527613j,
                0.0044133 +0.00534187j, 0.00444293+0.00540598j,
                0.00447324+0.0054681j , 0.00450428+0.00552789j,
                0.00453606+0.00558505j, 0.0045686 +0.00563931j,
                0.00460191+0.00569046j, 0.004636  +0.00573831j,
                0.00467088+0.00578272j, 0.00470653+0.00582359j,
                0.00474295+0.00586087j, 0.00478014+0.00589454j,
                0.00481808+0.00592464j, 0.00485678+0.00595121j,
                0.0048962 +0.00597435j, 0.00493635+0.00599416j,
                0.0049772 +0.0060108j , 0.00501873+0.00602441j,
                0.00506092+0.00603518j, 0.00510374+0.00604327j,
                0.00514716+0.00604888j, 0.00519115+0.0060522j ,
                0.00523566+0.00605342j, 0.00528066+0.00605275j,
                0.0053261 +0.00605037j, 0.00537193+0.00604646j,
                0.0054181 +0.00604121j, 0.00546455+0.00603479j,
                0.00551124+0.00602737j, 0.0055581 +0.0060191j ,
                0.00560508+0.00601015j, 0.00565214+0.00600064j,
                0.00569921+0.00599072j, 0.00574625+0.00598052j,
                0.00579321+0.00597015j, 0.00584006+0.00595973j,
                0.00588676+0.00594936j, 0.00593327+0.00593914j,
                0.00597956+0.00592916j]),
        'vz_offset_eps': 1,
        'q_vector': np.array([-3.20211857e+05, -4.59442569e+05, -1.30321812e+05, -1.30209048e+05,
                -1.30057266e+05, -1.29851869e+05, -1.29573211e+05, -1.29195938e+05,
                -1.28689482e+05, -1.28020927e+05, -1.27161115e+05, -1.26093171e+05,
                -1.24820060e+05, -1.23366151e+05, -1.21771022e+05, -1.20078480e+05,
                -1.18326941e+05, -1.16544584e+05, -1.14749202e+05, -1.12950524e+05,
                -1.11153021e+05, -1.09358185e+05, -1.07565941e+05, -1.05775436e+05,
                -1.03985409e+05, -1.02194430e+05, -1.00401057e+05, -9.86040140e+04,
                -9.68023405e+04, -9.49955192e+04, -9.31835517e+04, -9.13669873e+04,
                -8.95469026e+04, -8.77248161e+04, -8.59025306e+04, -8.40819328e+04,
                -8.22648079e+04, -8.04527118e+04, -7.86469162e+04, -7.68484103e+04,
                -7.50579258e+04, -7.32759286e+04, -7.15025848e+04, -6.97377094e+04,
                -6.79807539e+04, -6.62308571e+04, -6.44869232e+04, -6.27476598e+04,
                -6.10115491e+04, -5.92767988e+04, -5.75413584e+04, -5.58030364e+04,
                -5.40596871e+04, -5.23093909e+04, -5.05505903e+04, -4.87821724e+04,
                -4.70034922e+04, -4.52143370e+04, -4.34148463e+04, -4.16054724e+04,
                -3.97870094e+04, -3.79606683e+04, -3.61281231e+04, -3.42914767e+04,
                -3.24531337e+04, -3.06156266e+04, -2.87814499e+04, -2.69529648e+04,
                -2.51324006e+04, -2.33219259e+04, -2.15237474e+04, -1.97402187e+04,
                -1.79739904e+04, -1.62282734e+04, -1.45072684e+04, -1.28167916e+04,
                -1.11651229e+04, -9.56406425e+03, -8.03006941e+03, -6.58497664e+03,
                -5.25547649e+03, -4.07023466e+03, -3.05423879e+03, -2.22177302e+03,
                -1.57138003e+03, -1.08591711e+03, -7.37718617e+02, -4.95765870e+02,
                -3.31455594e+02, -2.21527108e+02, -1.48587525e+02, -1.00336558e+02,
                -6.83843652e+01])
        }
    
    drt = DRT(fit_inductance=True, fit_capacitance=False, fit_dop=False, fit_ohmic=True)
    
    # Default settings
    hypers = dict(
        rp_scale=14,
        derivative_weights=np.array([1.5, 1.0, 0.5]),
        sigma_ds=np.array([1, 1000, 1000]),
        l1_lambda_0=0,
        l2_lambda_0=142,
        s_alpha = np.array([5, 10, 25]),
        rho_alpha = np.array([0.15, 0.2, 0.25]),
        iw_alpha = None,
        iw_beta = None,
        s_0=np.ones(3),
        rho_0=np.ones(3),
        outlier_p=None,
    )
    
    drt.fit_eis(freq, z_noisy, **hypers)
    
    for key, exp_val in expected_result.items():
        val = drt.fit_parameters[key]
        
        if exp_val is None:
            assert val is None
        else:    
            assert np.allclose(val, drt.fit_parameters[key])
    
    
    